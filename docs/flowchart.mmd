flowchart TD
  A[Landing] -->|Join| PJ[Player View]
  A -->|Host| HCheck[Validate HouseCert + Sync Unsynced Ledger]

  HCheck -->|Valid + Synced| H[House View]
  HCheck -->|Invalid| Purchase[/Purchase / Install HouseCert/]

  Purchase --> A

  subgraph House_Table
    H --> Seats[Add Seat - local or via JoinResponse]
    Seats -->|admission entry| L1[(Local Ledger)]

    H --> JQR[Create Join Challenge QR]
    JQR --> Disp[Display QR on screen]

    subgraph Players
      PJ --> JoinClick[Join Table]
      JoinClick --> GenKeys[Gen player keys + HMAC]
      GenKeys --> ScanJ[Scan Join Challenge]
      ScanJ --> PJResp[Compute JoinResponse - HMAC + Sig]
      PJResp --> PJShow[Show JoinResponse QR]:::optional
    end

    H --> RespScan[Scan JoinResponse]
    RespScan --> SeatAssign[Assign seat + log admission]
    SeatAssign --> AdmitConf[Confirm Admission]
    AdmitConf --> L1

    H --> Bets[Open Round; seats place bets]
    Bets --> Lock[Lock Bets]
    Lock --> Certs[Issue Bet Certificates]
    Certs --> ShowBC[Show Bet Cert QRs]
    Lock -->|round_locked + bet_cert_issued| L2[(Local Ledger)]

    Lock --> Roll[Manual Roll d20]
    Roll --> Settle[Compute deltas; issue BANK Receipts]
    Settle --> ShowBR[Show receipt QRs / download JSON]
    Settle -->|round_settled + receipt_issued| L3[(Local Ledger)]
  end

  H --> SyncHost[Sync on Host selection - only online moment]
  L1 --> L2 --> L3 --> SyncPending[Unsynced Ledger]
  SyncPending --> SyncHost
  SyncHost --> Challenge[Authority /sync/challenge]:::cloud
  Challenge --> Commit[Authority /sync]:::cloud
  Commit --> LedgerSynced[(Ledger Synced)]

  classDef cloud fill:#eef,stroke:#88f
  classDef optional fill:#ffd,stroke:#cc9
